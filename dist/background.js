(()=>{"use strict";var t={719:t=>{var e=Object.prototype.hasOwnProperty,n="~";function i(){}function r(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function o(t,e,i,o,s){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new r(i,o||t,s),c=n?n+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],a]:t._events[c].push(a):(t._events[c]=a,t._eventsCount++),t}function s(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),a.prototype.eventNames=function(){var t,i,r=[];if(0===this._eventsCount)return r;for(i in t=this._events)e.call(t,i)&&r.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(t)):r},a.prototype.listeners=function(t){var e=n?n+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,o=i.length,s=new Array(o);r<o;r++)s[r]=i[r].fn;return s},a.prototype.listenerCount=function(t){var e=n?n+t:t,i=this._events[e];return i?i.fn?1:i.length:0},a.prototype.emit=function(t,e,i,r,o,s){var a=n?n+t:t;if(!this._events[a])return!1;var c,h,f=this._events[a],l=arguments.length;if(f.fn){switch(f.once&&this.removeListener(t,f.fn,void 0,!0),l){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,e),!0;case 3:return f.fn.call(f.context,e,i),!0;case 4:return f.fn.call(f.context,e,i,r),!0;case 5:return f.fn.call(f.context,e,i,r,o),!0;case 6:return f.fn.call(f.context,e,i,r,o,s),!0}for(h=1,c=new Array(l-1);h<l;h++)c[h-1]=arguments[h];f.fn.apply(f.context,c)}else{var u,p=f.length;for(h=0;h<p;h++)switch(f[h].once&&this.removeListener(t,f[h].fn,void 0,!0),l){case 1:f[h].fn.call(f[h].context);break;case 2:f[h].fn.call(f[h].context,e);break;case 3:f[h].fn.call(f[h].context,e,i);break;case 4:f[h].fn.call(f[h].context,e,i,r);break;default:if(!c)for(u=1,c=new Array(l-1);u<l;u++)c[u-1]=arguments[u];f[h].fn.apply(f[h].context,c)}}return!0},a.prototype.on=function(t,e,n){return o(this,t,e,n,!1)},a.prototype.once=function(t,e,n){return o(this,t,e,n,!0)},a.prototype.removeListener=function(t,e,i,r){var o=n?n+t:t;if(!this._events[o])return this;if(!e)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==e||r&&!a.once||i&&a.context!==i||s(this,o);else{for(var c=0,h=[],f=a.length;c<f;c++)(a[c].fn!==e||r&&!a[c].once||i&&a[c].context!==i)&&h.push(a[c]);h.length?this._events[o]=1===h.length?h[0]:h:s(this,o)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&s(this,e)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,t.exports=a}},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var o=e[i]={exports:{}};return t[i](o,o.exports,n),o.exports}(()=>{var t=n(719);class e extends Error{constructor(t){super(t),this.name="TimeoutError"}}class i extends Error{constructor(t){super(),this.name="AbortError",this.message=t}}const r=t=>void 0===globalThis.DOMException?new i(t):new DOMException(t),o=t=>{const e=void 0===t.reason?r("This operation was aborted."):t.reason;return e instanceof Error?e:r(e)};var s,a=function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)};class c{constructor(){s.set(this,[])}enqueue(t,e){const n={priority:(e={priority:0,...e}).priority,run:t};if(this.size&&a(this,s,"f")[this.size-1].priority>=e.priority)return void a(this,s,"f").push(n);const i=function(t,e,n){let i=0,r=t.length;for(;r>0;){const n=Math.trunc(r/2);let s=i+n;o=t[s],e.priority-o.priority<=0?(i=++s,r-=n+1):r=n}var o;return i}(a(this,s,"f"),n);a(this,s,"f").splice(i,0,n)}dequeue(){const t=a(this,s,"f").shift();return null==t?void 0:t.run}filter(t){return a(this,s,"f").filter((e=>e.priority===t.priority)).map((t=>t.run))}get size(){return a(this,s,"f").length}}s=new WeakMap;var h,f,l,u,p,d,m,v,w,y,g,b,x,I,T,E,C,_,P,k,M,$,L,S,j,O,R=function(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n},N=function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)};class U extends Error{}f=new WeakMap,l=new WeakMap,u=new WeakMap,p=new WeakMap,d=new WeakMap,m=new WeakMap,v=new WeakMap,w=new WeakMap,y=new WeakMap,g=new WeakMap,b=new WeakMap,x=new WeakMap,I=new WeakMap,T=new WeakMap,h=new WeakSet,E=function(){return N(this,l,"f")||N(this,u,"f")<N(this,p,"f")},C=function(){return N(this,b,"f")<N(this,x,"f")},_=function(){var t;R(this,b,(t=N(this,b,"f"),--t),"f"),N(this,h,"m",M).call(this),this.emit("next")},P=function(){N(this,h,"m",L).call(this),N(this,h,"m",$).call(this),R(this,w,void 0,"f")},k=function(){const t=Date.now();if(void 0===N(this,v,"f")){const e=N(this,m,"f")-t;if(!(e<0))return void 0===N(this,w,"f")&&R(this,w,setTimeout((()=>{N(this,h,"m",P).call(this)}),e),"f"),!0;R(this,u,N(this,f,"f")?N(this,b,"f"):0,"f")}return!1},M=function(){if(0===N(this,y,"f").size)return N(this,v,"f")&&clearInterval(N(this,v,"f")),R(this,v,void 0,"f"),this.emit("empty"),0===N(this,b,"f")&&this.emit("idle"),!1;if(!N(this,I,"f")){const t=!N(this,h,"a",k);if(N(this,h,"a",E)&&N(this,h,"a",C)){const e=N(this,y,"f").dequeue();return!!e&&(this.emit("active"),e(),t&&N(this,h,"m",$).call(this),!0)}}return!1},$=function(){N(this,l,"f")||void 0!==N(this,v,"f")||(R(this,v,setInterval((()=>{N(this,h,"m",L).call(this)}),N(this,d,"f")),"f"),R(this,m,Date.now()+N(this,d,"f"),"f"))},L=function(){0===N(this,u,"f")&&0===N(this,b,"f")&&N(this,v,"f")&&(clearInterval(N(this,v,"f")),R(this,v,void 0,"f")),R(this,u,N(this,f,"f")?N(this,b,"f"):0,"f"),N(this,h,"m",S).call(this)},S=function(){for(;N(this,h,"m",M).call(this););},j=async function(t){return new Promise(((e,n)=>{t.addEventListener("abort",(()=>{n(new U("The task was aborted."))}),{once:!0})}))},O=async function(t,e){return new Promise((n=>{const i=()=>{e&&!e()||(this.off(t,i),n())};this.on(t,i)}))};const W={annoProjectName:"",watchlist:["anno","",""]},z=new class extends t{constructor(t){var e,n,i,r;if(super(),h.add(this),f.set(this,void 0),l.set(this,void 0),u.set(this,0),p.set(this,void 0),d.set(this,void 0),m.set(this,0),v.set(this,void 0),w.set(this,void 0),y.set(this,void 0),g.set(this,void 0),b.set(this,0),x.set(this,void 0),I.set(this,void 0),T.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!("number"==typeof(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:c,...t}).intervalCap&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(e=t.intervalCap)||void 0===e?void 0:e.toString())&&void 0!==n?n:""}\` (${typeof t.intervalCap})`);if(void 0===t.interval||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(r=null===(i=t.interval)||void 0===i?void 0:i.toString())&&void 0!==r?r:""}\` (${typeof t.interval})`);R(this,f,t.carryoverConcurrencyCount,"f"),R(this,l,t.intervalCap===Number.POSITIVE_INFINITY||0===t.interval,"f"),R(this,p,t.intervalCap,"f"),R(this,d,t.interval,"f"),R(this,y,new t.queueClass,"f"),R(this,g,t.queueClass,"f"),this.concurrency=t.concurrency,this.timeout=t.timeout,R(this,T,!0===t.throwOnTimeout,"f"),R(this,I,!1===t.autoStart,"f")}get concurrency(){return N(this,x,"f")}set concurrency(t){if(!("number"==typeof t&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);R(this,x,t,"f"),N(this,h,"m",S).call(this)}async add(t,n={}){return n={timeout:this.timeout,throwOnTimeout:N(this,T,"f"),...n},new Promise(((i,r)=>{N(this,y,"f").enqueue((async()=>{var s,a,c;R(this,b,(a=N(this,b,"f"),++a),"f"),R(this,u,(c=N(this,u,"f"),++c),"f");try{if(null===(s=n.signal)||void 0===s?void 0:s.aborted)throw new U("The task was aborted.");let r=t({signal:n.signal});n.timeout&&(r=function(t,n,i,r){let s;const a=new Promise(((a,c)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(n!==Number.POSITIVE_INFINITY){if((r={customTimers:{setTimeout,clearTimeout},...r}).signal){const{signal:t}=r;t.aborted&&c(o(t)),t.addEventListener("abort",(()=>{c(o(t))}))}s=r.customTimers.setTimeout.call(void 0,(()=>{const r=i instanceof Error?i:new e(`Promise timed out after ${n} milliseconds`);"function"==typeof t.cancel&&t.cancel(),c(r)}),n),(async()=>{try{a(await t)}catch(t){c(t)}finally{r.customTimers.clearTimeout.call(void 0,s)}})()}else a(t)}));return a.clear=()=>{clearTimeout(s),s=void 0},a}(Promise.resolve(r),n.timeout)),n.signal&&(r=Promise.race([r,N(this,h,"m",j).call(this,n.signal)]));const a=await r;i(a),this.emit("completed",a)}catch(t){if(t instanceof e&&!n.throwOnTimeout)return void i();r(t),this.emit("error",t)}finally{N(this,h,"m",_).call(this)}}),n),this.emit("add"),N(this,h,"m",M).call(this)}))}async addAll(t,e){return Promise.all(t.map((async t=>this.add(t,e))))}start(){return N(this,I,"f")?(R(this,I,!1,"f"),N(this,h,"m",S).call(this),this):this}pause(){R(this,I,!0,"f")}clear(){R(this,y,new(N(this,g,"f")),"f")}async onEmpty(){0!==N(this,y,"f").size&&await N(this,h,"m",O).call(this,"empty")}async onSizeLessThan(t){N(this,y,"f").size<t||await N(this,h,"m",O).call(this,"next",(()=>N(this,y,"f").size<t))}async onIdle(){0===N(this,b,"f")&&0===N(this,y,"f").size||await N(this,h,"m",O).call(this,"idle")}get size(){return N(this,y,"f").size}sizeBy(t){return N(this,y,"f").filter(t).length}get pending(){return N(this,b,"f")}get isPaused(){return N(this,I,"f")}}({interval:1e3,intervalCap:1}),A=(t,e)=>z.add((()=>fetch(t,e)),{throwOnTimeout:!0});chrome.action.onClicked.addListener((async t=>{if("number"!=typeof t.id)return;const{annoProjectName:e}=await chrome.storage.sync.get(W);if(!e)return void chrome.runtime.openOptionsPage();const n={type:"annotate",annoProjectName:e};chrome.tabs.sendMessage(t.id,n)}));const F=new Map,q=({tabId:t})=>{F.get(t)?.(),F.delete(t)},D=new Map,V=new Map;chrome.runtime.onMessage.addListener((async(t,e)=>{const n=e.tab?.id;if(!n)throw new Error("tabId is empty. ");"urlChange"===t.type&&await(async({tabId:t,url:e})=>{q({tabId:t});const n=(t=>{const e=new URL(t);return e.protocol=new Map([["http:","anno:"],["https:","annos:"]]).get(e.protocol)??e.protocol,decodeURI(String(e))})(e),i=[],{watchlist:r,annoProjectName:o}=await chrome.storage.sync.get(W);for(const t of new Set([o,...r])){if(!t)continue;let e=await V.get(t);if(void 0===e){const n=(async()=>{const e=await A(`https://scrapbox.io/api/projects/${encodeURIComponent(t)}`);return e.ok?await e.json():(console.error(`Failed to fetch project: ${e.status}`),null)})();V.set(t,n),e=await n}e&&i.push(e)}const s=new Map,a=[];for(const t of i){const e=await A(`https://scrapbox.io/api/pages/${encodeURIComponent(t.name)}/${encodeURIComponent(n)}?followRename=true`);if(!e.ok){console.error(`Failed to fetch page: ${e.status}`);continue}const i=await e.json(),r=[];let o=[];for(const t of i.lines.slice(1))t.text?o.push(t):(r.push(o),o=[]);r.push(o);for(const e of r)if(e.length)for(const i of e[0].text.matchAll(/\[[^\]]*\s(.*?)\]/g)){let r;try{r=new URLSearchParams(new URL(i[1]).hash)}catch{continue}const o=r.get("e");if(!o)continue;const c=[];for(const n of e[0].text.matchAll(/(\[?)\[([^\]]+)\.icon(?:\*([1-9]\d*))?\](\]?)/g)){const e=n[2],i=Number(n[3]??"1"),r=Boolean(n[1]&&n[4]),o=`/${t.name}/${e}`;let s=await D.get(o);if(void 0===s){const n=(async()=>{const n=await A(`https://scrapbox.io/api/pages/${encodeURIComponent(t.name)}/${encodeURIComponent(e)}`);if(!n.ok)return console.error(`Failed to fetch iconAPI: ${n.status}`),null;const{image:i}=await n.json(),r=await fetch(i);if(!r.ok)return console.error(`Failed to fetch the icon image: ${r.status}`),null;const o=new FileReader;return new Promise((async t=>{o.addEventListener("load",(()=>{if("string"!=typeof o.result)throw new Error("fileReader result is not string. ");t(o.result)})),o.readAsDataURL(await r.blob())}))})();D.set(o,n),s=await n}if(s)for(const t of Array(i).keys())c.push({url:s,isStrong:r})}c.length||c.push({url:t.image??"https://i.gyazo.com/1e3dbb79088aa1627d7e092481848df5.png",isStrong:!1});for(const i of c){const c=crypto.randomUUID(),h=i.isStrong?60:20;s.set(c,{url:`https://scrapbox.io/${encodeURIComponent(t.name)}/${encodeURIComponent(n)}#${e[0].id}`,description:e.slice(1).map((({text:t})=>t)).join("\n"),iconImageURL:i.url,iconSize:h});const f={textQuoteSelector:{prefix:r.get("p")??void 0,exact:o,suffix:r.get("s")??void 0},annotationURL:`${chrome.runtime.getURL("annotation.html")}?${new URLSearchParams({id:c})}`,iconSize:h};a.push(f)}}}await chrome.storage.local.set(Object.fromEntries(s));const c={type:"inject",configs:a};chrome.tabs.sendMessage(t,c),F.set(t,(async()=>{await chrome.storage.local.remove([...s.keys()])}))})({tabId:n,url:t.url})})),chrome.tabs.onRemoved.addListener((t=>{q({tabId:t})})),chrome.tabs.onReplaced.addListener(((t,e)=>{q({tabId:e})}))})()})();