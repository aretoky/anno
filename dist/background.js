(()=>{"use strict";var e,t,o,n,r={51:(e,t,o)=>{o.a(e,(async(e,t)=>{try{var n=o(65),r=o(919);chrome.action.onClicked.addListener((async e=>{if("number"!=typeof e.id)return;const{annoProjectName:t}=await chrome.storage.sync.get(n.a);if(!t)return void chrome.runtime.openOptionsPage();const o={type:"getTextQuoteSelectorfromSelection",annoProjectName:t};chrome.tabs.sendMessage(e.id,o)}));const e=await fetch("https://scrapbox.io/api/projects");if(!e.ok)throw new Error(`Failed to fetch projects: ${e.status}`);const{projects:a}=await e.json(),s=await Promise.all([...a].sort(((e,t)=>t.updated-e.updated)).slice(0,5).map((async e=>{const t=await fetch(`https://scrapbox.io/api/projects/${encodeURIComponent(e.name)}`);if(!t.ok)throw new Error(`Failed to fetch project: ${t.status}`);return t.json()}))),c=new Map;chrome.tabs.onUpdated.addListener((async(e,t,o)=>{if("complete"!==t.status||!o.url)return;const n=(0,r.e)((0,r.V)(o.url)),a=new Map,i=[];await Promise.all(s.map((async e=>{const t=await fetch(`https://scrapbox.io/api/pages/${encodeURIComponent(e.name)}/${encodeURIComponent(n)}?followRename=true`);if(!t.ok)throw new Error(`Failed to fetch page: ${t.status}`);const o=await t.json(),r=[];let s=[];for(const e of o.lines.slice(1))e.text?s.push(e):(r.push(s),s=[]);r.push(s);for(const t of r)if(t.length)for(const o of t[0].text.matchAll(/\[[^\]]*\s(.*?)\]/g)){let r;try{r=new URLSearchParams(new URL(o[1]).hash)}catch{continue}const s=r.get("e");if(!s)continue;let p=t[0].text;for(const e of p.matchAll(/\[([^\[\]]+\.icon)\*([1-9]\d*)\]/g))p=p.replace(e[0],`[${e[1]}]`.repeat(Math.min(Number(e[2]),100)));const h=[];for(const t of p.matchAll(/\[([^\[\]]+)\.icon\]/g)){const o=t[1];let n=c.get(o);if(!n){const t=await fetch(`https://scrapbox.io/api/pages/${encodeURIComponent(e.name)}/${encodeURIComponent(o)}`);if(!t.ok)throw new Error(`Failed to fetch iconAPI: ${t.status}`);const{image:r}=await t.json();c.set(o,r),n=r}h.push(n)}h.length||h.push(e.image);for(const o of h){const c=crypto.randomUUID();a.set(c,{url:`https://scrapbox.io/${encodeURIComponent(e.name)}/${encodeURIComponent(n)}#${t[0].id}`,description:t.slice(1).map((({text:e})=>e)).join("\n"),iconImageURL:o});const p={textQuoteSelector:{prefix:r.get("p")??void 0,exact:s,suffix:r.get("s")??void 0},annotationURL:`${chrome.runtime.getURL("annotation.html")}?${new URLSearchParams({id:c})}`};i.push(p)}}}))),await chrome.storage.session.set(Object.fromEntries(a));const p={type:"inject",configs:i};chrome.tabs.sendMessage(e,p)})),t()}catch(e){t(e)}}),1)},65:(e,t,o)=>{o.d(t,{a:()=>n});const n={annoProjectName:""}},919:(e,t,o)=>{o.d(t,{V:()=>r,e:()=>n});const n=e=>{const t=new URL(e);return t.protocol=new Map([["http:","anno:"],["https:","annos:"]]).get(t.protocol)??t.protocol,decodeURI(String(t))},r=e=>{const t=new URL(e);return t.hash="",t.search="",String(t)}}},a={};function s(e){var t=a[e];if(void 0!==t)return t.exports;var o=a[e]={exports:{}};return r[e](o,o.exports,s),o.exports}e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",o="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",n=e=>{e&&!e.d&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},s.a=(r,a,s)=>{var c;s&&((c=[]).d=1);var i,p,h,m=new Set,f=r.exports,u=new Promise(((e,t)=>{h=t,p=e}));u[t]=f,u[e]=e=>(c&&e(c),m.forEach(e),u.catch((e=>{}))),r.exports=u,a((r=>{var a;i=(r=>r.map((r=>{if(null!==r&&"object"==typeof r){if(r[e])return r;if(r.then){var a=[];a.d=0,r.then((e=>{s[t]=e,n(a)}),(e=>{s[o]=e,n(a)}));var s={};return s[e]=e=>e(a),s}}var c={};return c[e]=e=>{},c[t]=r,c})))(r);var s=()=>i.map((e=>{if(e[o])throw e[o];return e[t]})),p=new Promise((t=>{(a=()=>t(s)).r=0;var o=e=>e!==c&&!m.has(e)&&(m.add(e),e&&!e.d&&(a.r++,e.push(a)));i.map((t=>t[e](o)))}));return a.r?p:s()}),(e=>(e?h(u[o]=e):p(f),n(c)))),c&&(c.d=0)},s.d=(e,t)=>{for(var o in t)s.o(t,o)&&!s.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s(51)})();