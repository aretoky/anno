(()=>{"use strict";var e,t,o,r,a={51:(e,t,o)=>{o.a(e,(async(e,t)=>{try{var r=o(65),a=o(919);chrome.action.onClicked.addListener((async e=>{if("number"!=typeof e.id)return;const{annoProjectName:t}=await chrome.storage.sync.get(r.a);if(!t)return void chrome.runtime.openOptionsPage();const o={type:"getTextQuoteSelectorfromSelection",annoProjectName:t};chrome.tabs.sendMessage(e.id,o)}));const e=await fetch("https://scrapbox.io/api/projects");if(!e.ok)throw new Error(`Failed to fetch projects: ${e.status}`);const{projects:n}=await e.json(),s=await Promise.all([...n].sort(((e,t)=>t.updated-e.updated)).slice(0,3).map((async e=>{const t=await fetch(`https://scrapbox.io/api/projects/${encodeURIComponent(e.name)}`);if(!t.ok)throw new Error(`Failed to fetch project: ${t.status}`);return t.json()}))),c=new Map,i=({tabId:e})=>{c.get(e)?.(),c.delete(e)},p=new Map,d=async({tabId:e,url:t})=>{i({tabId:e});const o=(0,a.eo)((0,a.VQ)(t)),r=new Map,n=[];await Promise.all(s.map((async e=>{const t=await fetch(`https://scrapbox.io/api/pages/${encodeURIComponent(e.name)}/${encodeURIComponent(o)}?followRename=true`);if(!t.ok)throw new Error(`Failed to fetch page: ${t.status}`);const a=await t.json(),s=[];let c=[];for(const e of a.lines.slice(1))e.text?c.push(e):(s.push(c),c=[]);s.push(c);for(const t of s)if(t.length)for(const a of t[0].text.matchAll(/\[[^\]]*\s(.*?)\]/g)){let s;try{s=new URLSearchParams(new URL(a[1]).hash)}catch{continue}const c=s.get("e");if(!c)continue;let i=t[0].text;for(const e of i.matchAll(/\[([^\[\]]+\.icon)\*([1-9]\d*)\]/g))i=i.replace(e[0],`[${e[1]}]`.repeat(Math.min(Number(e[2]),100)));const d=[];for(const t of i.matchAll(/\[([^\[\]]+)\.icon\]/g)){const o=t[1],r=`/${e.name}/${o}`;let a=p.get(r);if(!a){const t=await fetch(`https://scrapbox.io/api/pages/${encodeURIComponent(e.name)}/${encodeURIComponent(o)}`);if(!t.ok)throw new Error(`Failed to fetch iconAPI: ${t.status}`);const{image:n}=await t.json(),s=await fetch(n);if(!s.ok)throw new Error(`Failed to fetch the icon image: ${s.status}`);const c=new FileReader;a=await new Promise((async e=>{c.addEventListener("load",(()=>{if("string"!=typeof c.result)throw new Error("fileReader result is not string. ");e(c.result)})),c.readAsDataURL(await s.blob())})),p.set(r,a)}d.push(a)}d.length||d.push(e.image);for(const a of d){const i=crypto.randomUUID();r.set(i,{url:`https://scrapbox.io/${encodeURIComponent(e.name)}/${encodeURIComponent(o)}#${t[0].id}`,description:t.slice(1).map((({text:e})=>e)).join("\n"),iconImageURL:a});const p={textQuoteSelector:{prefix:s.get("p")??void 0,exact:c,suffix:s.get("s")??void 0},annotationURL:`${chrome.runtime.getURL("annotation.html")}?${new URLSearchParams({id:i})}`};n.push(p)}}}))),await chrome.storage.local.set(Object.fromEntries(r));const d={type:"inject",configs:n};chrome.tabs.sendMessage(e,d),c.set(e,(async()=>{await chrome.storage.local.remove([...r.keys()])}))};chrome.runtime.onMessage.addListener((async(e,t)=>{const o=t.tab?.id;if(!o)throw new Error("tabId is empty. ");const r=t.tab?.url;if(!r)throw new Error("url is empty. ");"load"===e.type&&await d({tabId:o,url:r})})),chrome.tabs.onUpdated.addListener((async(e,t)=>{t.url&&await d({tabId:e,url:t.url})})),chrome.tabs.onRemoved.addListener((e=>{i({tabId:e})})),chrome.tabs.onReplaced.addListener(((e,t)=>{i({tabId:t})})),t()}catch(e){t(e)}}),1)},65:(e,t,o)=>{o.d(t,{a:()=>r});const r={annoProjectName:""}},919:(e,t,o)=>{o.d(t,{VQ:()=>a,eo:()=>r});const r=e=>{const t=new URL(e);return t.protocol=new Map([["http:","anno:"],["https:","annos:"]]).get(t.protocol)??t.protocol,decodeURI(String(t))},a=e=>{const t=new URL(e);return t.hash="",t.search="",String(t)}}},n={};function s(e){var t=n[e];if(void 0!==t)return t.exports;var o=n[e]={exports:{}};return a[e](o,o.exports,s),o.exports}e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",o="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",r=e=>{e&&!e.d&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},s.a=(a,n,s)=>{var c;s&&((c=[]).d=1);var i,p,d,h=new Set,l=a.exports,m=new Promise(((e,t)=>{d=t,p=e}));m[t]=l,m[e]=e=>(c&&e(c),h.forEach(e),m.catch((e=>{}))),a.exports=m,n((a=>{var n;i=(a=>a.map((a=>{if(null!==a&&"object"==typeof a){if(a[e])return a;if(a.then){var n=[];n.d=0,a.then((e=>{s[t]=e,r(n)}),(e=>{s[o]=e,r(n)}));var s={};return s[e]=e=>e(n),s}}var c={};return c[e]=e=>{},c[t]=a,c})))(a);var s=()=>i.map((e=>{if(e[o])throw e[o];return e[t]})),p=new Promise((t=>{(n=()=>t(s)).r=0;var o=e=>e!==c&&!h.has(e)&&(h.add(e),e&&!e.d&&(n.r++,e.push(n)));i.map((t=>t[e](o)))}));return n.r?p:s()}),(e=>(e?d(m[o]=e):p(l),r(c)))),c&&(c.d=0)},s.d=(e,t)=>{for(var o in t)s.o(t,o)&&!s.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s(51)})();