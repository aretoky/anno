(()=>{"use strict";var t={719:t=>{var e=Object.prototype.hasOwnProperty,n="~";function i(){}function o(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function r(t,e,i,r,s){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new o(i,r||t,s),c=n?n+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],a]:t._events[c].push(a):(t._events[c]=a,t._eventsCount++),t}function s(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),a.prototype.eventNames=function(){var t,i,o=[];if(0===this._eventsCount)return o;for(i in t=this._events)e.call(t,i)&&o.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(t)):o},a.prototype.listeners=function(t){var e=n?n+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var o=0,r=i.length,s=new Array(r);o<r;o++)s[o]=i[o].fn;return s},a.prototype.listenerCount=function(t){var e=n?n+t:t,i=this._events[e];return i?i.fn?1:i.length:0},a.prototype.emit=function(t,e,i,o,r,s){var a=n?n+t:t;if(!this._events[a])return!1;var c,h,l=this._events[a],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(t,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,e),!0;case 3:return l.fn.call(l.context,e,i),!0;case 4:return l.fn.call(l.context,e,i,o),!0;case 5:return l.fn.call(l.context,e,i,o,r),!0;case 6:return l.fn.call(l.context,e,i,o,r,s),!0}for(h=1,c=new Array(f-1);h<f;h++)c[h-1]=arguments[h];l.fn.apply(l.context,c)}else{var u,p=l.length;for(h=0;h<p;h++)switch(l[h].once&&this.removeListener(t,l[h].fn,void 0,!0),f){case 1:l[h].fn.call(l[h].context);break;case 2:l[h].fn.call(l[h].context,e);break;case 3:l[h].fn.call(l[h].context,e,i);break;case 4:l[h].fn.call(l[h].context,e,i,o);break;default:if(!c)for(u=1,c=new Array(f-1);u<f;u++)c[u-1]=arguments[u];l[h].fn.apply(l[h].context,c)}}return!0},a.prototype.on=function(t,e,n){return r(this,t,e,n,!1)},a.prototype.once=function(t,e,n){return r(this,t,e,n,!0)},a.prototype.removeListener=function(t,e,i,o){var r=n?n+t:t;if(!this._events[r])return this;if(!e)return s(this,r),this;var a=this._events[r];if(a.fn)a.fn!==e||o&&!a.once||i&&a.context!==i||s(this,r);else{for(var c=0,h=[],l=a.length;c<l;c++)(a[c].fn!==e||o&&!a[c].once||i&&a[c].context!==i)&&h.push(a[c]);h.length?this._events[r]=1===h.length?h[0]:h:s(this,r)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&s(this,e)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,t.exports=a}},e={};function n(i){var o=e[i];if(void 0!==o)return o.exports;var r=e[i]={exports:{}};return t[i](r,r.exports,n),r.exports}(()=>{var t=n(719);class e extends Error{constructor(t){super(t),this.name="TimeoutError"}}class i extends Error{constructor(t){super(),this.name="AbortError",this.message=t}}const o=t=>void 0===globalThis.DOMException?new i(t):new DOMException(t),r=t=>{const e=void 0===t.reason?o("This operation was aborted."):t.reason;return e instanceof Error?e:o(e)};var s,a=function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)};class c{constructor(){s.set(this,[])}enqueue(t,e){const n={priority:(e={priority:0,...e}).priority,run:t};if(this.size&&a(this,s,"f")[this.size-1].priority>=e.priority)return void a(this,s,"f").push(n);const i=function(t,e,n){let i=0,o=t.length;for(;o>0;){const n=Math.trunc(o/2);let s=i+n;r=t[s],e.priority-r.priority<=0?(i=++s,o-=n+1):o=n}var r;return i}(a(this,s,"f"),n);a(this,s,"f").splice(i,0,n)}dequeue(){const t=a(this,s,"f").shift();return null==t?void 0:t.run}filter(t){return a(this,s,"f").filter((e=>e.priority===t.priority)).map((t=>t.run))}get size(){return a(this,s,"f").length}}s=new WeakMap;var h,l,f,u,p,d,m,w,v,y,g,b,x,k,I,T,E,C,_,M,P,$,j,L,R,N,O=function(t,e,n,i,o){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?o.call(t,n):o?o.value=n:e.set(t,n),n},S=function(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)};class U extends Error{}l=new WeakMap,f=new WeakMap,u=new WeakMap,p=new WeakMap,d=new WeakMap,m=new WeakMap,w=new WeakMap,v=new WeakMap,y=new WeakMap,g=new WeakMap,b=new WeakMap,x=new WeakMap,k=new WeakMap,I=new WeakMap,h=new WeakSet,T=function(){return S(this,f,"f")||S(this,u,"f")<S(this,p,"f")},E=function(){return S(this,b,"f")<S(this,x,"f")},C=function(){var t;O(this,b,(t=S(this,b,"f"),--t),"f"),S(this,h,"m",P).call(this),this.emit("next")},_=function(){S(this,h,"m",j).call(this),S(this,h,"m",$).call(this),O(this,v,void 0,"f")},M=function(){const t=Date.now();if(void 0===S(this,w,"f")){const e=S(this,m,"f")-t;if(!(e<0))return void 0===S(this,v,"f")&&O(this,v,setTimeout((()=>{S(this,h,"m",_).call(this)}),e),"f"),!0;O(this,u,S(this,l,"f")?S(this,b,"f"):0,"f")}return!1},P=function(){if(0===S(this,y,"f").size)return S(this,w,"f")&&clearInterval(S(this,w,"f")),O(this,w,void 0,"f"),this.emit("empty"),0===S(this,b,"f")&&this.emit("idle"),!1;if(!S(this,k,"f")){const t=!S(this,h,"a",M);if(S(this,h,"a",T)&&S(this,h,"a",E)){const e=S(this,y,"f").dequeue();return!!e&&(this.emit("active"),e(),t&&S(this,h,"m",$).call(this),!0)}}return!1},$=function(){S(this,f,"f")||void 0!==S(this,w,"f")||(O(this,w,setInterval((()=>{S(this,h,"m",j).call(this)}),S(this,d,"f")),"f"),O(this,m,Date.now()+S(this,d,"f"),"f"))},j=function(){0===S(this,u,"f")&&0===S(this,b,"f")&&S(this,w,"f")&&(clearInterval(S(this,w,"f")),O(this,w,void 0,"f")),O(this,u,S(this,l,"f")?S(this,b,"f"):0,"f"),S(this,h,"m",L).call(this)},L=function(){for(;S(this,h,"m",P).call(this););},R=async function(t){return new Promise(((e,n)=>{t.addEventListener("abort",(()=>{n(new U("The task was aborted."))}),{once:!0})}))},N=async function(t,e){return new Promise((n=>{const i=()=>{e&&!e()||(this.off(t,i),n())};this.on(t,i)}))};const A={annoProjectName:""},W=t=>{const e=new URL(t);return e.protocol=new Map([["http:","anno:"],["https:","annos:"]]).get(e.protocol)??e.protocol,decodeURI(String(e))},z=new class extends t{constructor(t){var e,n,i,o;if(super(),h.add(this),l.set(this,void 0),f.set(this,void 0),u.set(this,0),p.set(this,void 0),d.set(this,void 0),m.set(this,0),w.set(this,void 0),v.set(this,void 0),y.set(this,void 0),g.set(this,void 0),b.set(this,0),x.set(this,void 0),k.set(this,void 0),I.set(this,void 0),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!("number"==typeof(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:c,...t}).intervalCap&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(e=t.intervalCap)||void 0===e?void 0:e.toString())&&void 0!==n?n:""}\` (${typeof t.intervalCap})`);if(void 0===t.interval||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(o=null===(i=t.interval)||void 0===i?void 0:i.toString())&&void 0!==o?o:""}\` (${typeof t.interval})`);O(this,l,t.carryoverConcurrencyCount,"f"),O(this,f,t.intervalCap===Number.POSITIVE_INFINITY||0===t.interval,"f"),O(this,p,t.intervalCap,"f"),O(this,d,t.interval,"f"),O(this,y,new t.queueClass,"f"),O(this,g,t.queueClass,"f"),this.concurrency=t.concurrency,this.timeout=t.timeout,O(this,I,!0===t.throwOnTimeout,"f"),O(this,k,!1===t.autoStart,"f")}get concurrency(){return S(this,x,"f")}set concurrency(t){if(!("number"==typeof t&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);O(this,x,t,"f"),S(this,h,"m",L).call(this)}async add(t,n={}){return n={timeout:this.timeout,throwOnTimeout:S(this,I,"f"),...n},new Promise(((i,o)=>{S(this,y,"f").enqueue((async()=>{var s,a,c;O(this,b,(a=S(this,b,"f"),++a),"f"),O(this,u,(c=S(this,u,"f"),++c),"f");try{if(null===(s=n.signal)||void 0===s?void 0:s.aborted)throw new U("The task was aborted.");let o=t({signal:n.signal});n.timeout&&(o=function(t,n,i,o){let s;const a=new Promise(((a,c)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(n!==Number.POSITIVE_INFINITY){if((o={customTimers:{setTimeout,clearTimeout},...o}).signal){const{signal:t}=o;t.aborted&&c(r(t)),t.addEventListener("abort",(()=>{c(r(t))}))}s=o.customTimers.setTimeout.call(void 0,(()=>{const o=i instanceof Error?i:new e(`Promise timed out after ${n} milliseconds`);"function"==typeof t.cancel&&t.cancel(),c(o)}),n),(async()=>{try{a(await t)}catch(t){c(t)}finally{o.customTimers.clearTimeout.call(void 0,s)}})()}else a(t)}));return a.clear=()=>{clearTimeout(s),s=void 0},a}(Promise.resolve(o),n.timeout)),n.signal&&(o=Promise.race([o,S(this,h,"m",R).call(this,n.signal)]));const a=await o;i(a),this.emit("completed",a)}catch(t){if(t instanceof e&&!n.throwOnTimeout)return void i();o(t),this.emit("error",t)}finally{S(this,h,"m",C).call(this)}}),n),this.emit("add"),S(this,h,"m",P).call(this)}))}async addAll(t,e){return Promise.all(t.map((async t=>this.add(t,e))))}start(){return S(this,k,"f")?(O(this,k,!1,"f"),S(this,h,"m",L).call(this),this):this}pause(){O(this,k,!0,"f")}clear(){O(this,y,new(S(this,g,"f")),"f")}async onEmpty(){0!==S(this,y,"f").size&&await S(this,h,"m",N).call(this,"empty")}async onSizeLessThan(t){S(this,y,"f").size<t||await S(this,h,"m",N).call(this,"next",(()=>S(this,y,"f").size<t))}async onIdle(){0===S(this,b,"f")&&0===S(this,y,"f").size||await S(this,h,"m",N).call(this,"idle")}get size(){return S(this,y,"f").size}sizeBy(t){return S(this,y,"f").filter(t).length}get pending(){return S(this,b,"f")}get isPaused(){return S(this,k,"f")}}({interval:5e3,intervalCap:5}),F=(t,e)=>z.add((()=>fetch(t,e)),{throwOnTimeout:!0});chrome.action.onClicked.addListener((async t=>{if("number"!=typeof t.id)return;const{annoProjectName:e}=await chrome.storage.sync.get(A);if(!e)return void chrome.runtime.openOptionsPage();const n={type:"annotate",annoProjectName:e};chrome.tabs.sendMessage(t.id,n)}));const q=new Map,D=({tabId:t})=>{q.get(t)?.(),q.delete(t)},V=({annolink:t,referencingLinks:e})=>{const n=e.indexOf(`${t.projectName?`/${t.projectName}/`:""}${t.title}`);return-1===n?Number.MAX_SAFE_INTEGER:n},Y=new Map,B=new Map;let G;chrome.runtime.onMessage.addListener((async(t,e)=>{const n=e.tab?.id;if(!n)throw new Error("tabId is empty. ");switch(t.type){case"open":{const e=G&&await Q(G);if(e&&e.id)await chrome.tabs.update(e.id,{active:!0,url:t.url}),await chrome.windows.update(e.windowId,{focused:!0});else{const e=await chrome.windows.create({type:"popup",url:t.url});G=e.tabs?.at(0)?.id}break}case"urlChange":await(async({tabId:t,url:e})=>{D({tabId:t});const{annodataMap:n,configs:i,existedAnnolink:o}=await(async({annolink:t})=>{const e=new Map,n=[],{annoProjectName:i}=await chrome.storage.sync.get(A);if(!i)return{annodataMap:e,configs:n};const o=await F(`https://scrapbox.io/api/pages/${encodeURIComponent(i)}/${encodeURIComponent(t)}`);if(!o.ok)return console.error(`Failed to fetch page: ${o.status}`),{annodataMap:e,configs:n};const r=await o.json(),s=[...r.lines.map((({text:t})=>t)).join("\n").matchAll(/\[(.*?)\]/g)].map((t=>t[1])),a=[...r.relatedPages.links1hop,...r.relatedPages.projectLinks1hop].sort(((t,e)=>V({annolink:t,referencingLinks:s})-V({annolink:e,referencingLinks:s}))),c=a.at(0);for(const t of a){const o=t.projectName??i;let r=await B.get(o);if(void 0===r){const t=(async()=>{const t=await F(`https://scrapbox.io/api/projects/${encodeURIComponent(o)}`);return t.ok?await t.json():(console.error(`Failed to fetch project: ${t.status}`),null)})();B.set(o,t),r=await t}if(!r)continue;const s=await F(`https://scrapbox.io/api/pages/${encodeURIComponent(r.name)}/${encodeURIComponent(t.title)}?followRename`);if(!s.ok){console.error(`Failed to fetch page: ${s.status}`);continue}const a=await s.json(),c=[];let h=[];for(const t of a.lines.slice(1))t.text?h.push(t):(c.push(h),h=[]);c.push(h);for(const t of c)if(t.length)for(const i of t[0].text.matchAll(/\[[^\]]*\s(.*?)\]/g)){let o;try{o=new URLSearchParams(new URL(i[1]).hash)}catch{continue}const s=o.get("e");if(!s)continue;const c=[];for(const e of t[0].text.matchAll(/(\[?)\[([^\]]+)\.icon(?:\*([1-9]\d*))?\](\]?)/g)){const t=e[2],n=Number(e[3]??"1"),i=Boolean(e[1]&&e[4]),o=`/${r.name}/${t}`;let s=await Y.get(o);if(void 0===s){const e=(async()=>{const e=await fetch(`https://scrapbox.io/api/pages/${encodeURIComponent(r.name)}/${encodeURIComponent(t)}/icon?followRename`);if(!e.ok)return console.error(`Failed to fetch icon: ${e.status}`),null;const n=new FileReader;return new Promise((async t=>{n.addEventListener("load",(()=>{if("string"!=typeof n.result)throw new Error("fileReader result is not string. ");t(n.result)})),n.readAsDataURL(await e.blob())}))})();Y.set(o,e),s=await e}if(s)for(const t of Array(n).keys())c.push({url:s,isStrong:i})}c.length||c.push({url:r.image??"https://i.gyazo.com/1e3dbb79088aa1627d7e092481848df5.png",isStrong:!1});for(const i of c){const c=crypto.randomUUID(),h=i.isStrong?60:20;e.set(c,{url:`https://scrapbox.io/${encodeURIComponent(r.name)}/${encodeURIComponent(a.title)}#${t[0].id}`,description:t.slice(1).map((({text:t})=>t)).join("\n"),iconImageURL:i.url,iconSize:h});const l={textQuoteSelector:{prefix:o.get("p")??void 0,exact:s,suffix:o.get("s")??void 0},annotationURL:`${chrome.runtime.getURL("annotation.html")}?${new URLSearchParams({id:c})}`,iconSize:h};n.push(l)}}}return{annodataMap:e,configs:n,existedAnnolink:c}})({annolink:W(e)});await chrome.storage.local.set(Object.fromEntries(n));const r={type:"inject",configs:i,existedAnnolink:o};chrome.tabs.sendMessage(t,r),q.set(t,(async()=>{await chrome.storage.local.remove([...n.keys()])}))})({tabId:n,url:t.url});break;default:throw new Error(`Unknown message type: ${t}`)}})),chrome.tabs.onRemoved.addListener((t=>{D({tabId:t})})),chrome.tabs.onReplaced.addListener(((t,e)=>{D({tabId:e})}));const Q=async t=>{try{return await chrome.tabs.get(t)}catch{}}})()})();