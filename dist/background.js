(()=>{"use strict";const t={annoProjectName:"",watchlist:["anno","",""]};chrome.action.onClicked.addListener((async e=>{if("number"!=typeof e.id)return;const{annoProjectName:o}=await chrome.storage.sync.get(t);if(!o)return void chrome.runtime.openOptionsPage();const n={type:"getTextQuoteSelectorfromSelection",annoProjectName:o};chrome.tabs.sendMessage(e.id,n)}));const e=new Map,o=({tabId:t})=>{e.get(t)?.(),e.delete(t)},n=new Map,a=new Map,s=async({tabId:s,url:r})=>{o({tabId:s});const c=(t=>{const e=new URL(t);return e.protocol=new Map([["http:","anno:"],["https:","annos:"]]).get(e.protocol)??e.protocol,decodeURI(String(e))})((t=>{const e=new URL(t);return e.hash="",e.search="",String(e)})(r)),i=[],{watchlist:l,annoProjectName:d}=await chrome.storage.sync.get(t);for(const t of new Set([d,...l])){if(!t)continue;let e=await a.get(t);if(void 0===e){const o=(async()=>{const e=await fetch(`https://scrapbox.io/api/projects/${encodeURIComponent(t)}`);return e.ok?await e.json():(console.error(`Failed to fetch project: ${e.status}`),null)})();a.set(t,o),e=await o}e&&i.push(e)}const p=new Map,h=[];for(const t of i){const e=await fetch(`https://scrapbox.io/api/pages/${encodeURIComponent(t.name)}/${encodeURIComponent(c)}?followRename=true`);if(!e.ok){console.error(`Failed to fetch page: ${e.status}`);continue}const o=await e.json(),a=[];let s=[];for(const t of o.lines.slice(1))t.text?s.push(t):(a.push(s),s=[]);a.push(s);for(const e of a)if(e.length)for(const o of e[0].text.matchAll(/\[[^\]]*\s(.*?)\]/g)){let a;try{a=new URLSearchParams(new URL(o[1]).hash)}catch{continue}const s=a.get("e");if(!s)continue;const r=[];for(const o of e[0].text.matchAll(/(\[?)\[([^\]]+)\.icon(?:\*([1-9]\d*))?\](\]?)/g)){const e=o[2],a=Number(o[3]??"1"),s=Boolean(o[1]&&o[4]),c=`/${t.name}/${e}`;let i=await n.get(c);if(void 0===i){const o=(async()=>{const o=await fetch(`https://scrapbox.io/api/pages/${encodeURIComponent(t.name)}/${encodeURIComponent(e)}`);if(!o.ok)return console.error(`Failed to fetch iconAPI: ${o.status}`),null;const{image:n}=await o.json(),a=await fetch(n);if(!a.ok)return console.error(`Failed to fetch the icon image: ${a.status}`),null;const s=new FileReader;return new Promise((async t=>{s.addEventListener("load",(()=>{if("string"!=typeof s.result)throw new Error("fileReader result is not string. ");t(s.result)})),s.readAsDataURL(await a.blob())}))})();n.set(c,o),i=await o}if(i)for(const t of Array(a).keys())r.push({url:i,isStrong:s})}r.length||r.push({url:t.image??"https://i.gyazo.com/1e3dbb79088aa1627d7e092481848df5.png",isStrong:!1});for(const o of r){const n=crypto.randomUUID(),r=o.isStrong?60:20;p.set(n,{url:`https://scrapbox.io/${encodeURIComponent(t.name)}/${encodeURIComponent(c)}#${e[0].id}`,description:e.slice(1).map((({text:t})=>t)).join("\n"),iconImageURL:o.url,iconSize:r});const i={textQuoteSelector:{prefix:a.get("p")??void 0,exact:s,suffix:a.get("s")??void 0},annotationURL:`${chrome.runtime.getURL("annotation.html")}?${new URLSearchParams({id:n})}`,iconSize:r};h.push(i)}}}await chrome.storage.local.set(Object.fromEntries(p));const m={type:"inject",configs:h};chrome.tabs.sendMessage(s,m),e.set(s,(async()=>{await chrome.storage.local.remove([...p.keys()])}))};chrome.runtime.onMessage.addListener((async(t,e)=>{const o=e.tab?.id;if(!o)throw new Error("tabId is empty. ");const n=e.tab?.url;if(!n)throw new Error("url is empty. ");"load"===t.type&&await s({tabId:o,url:n})})),chrome.tabs.onUpdated.addListener((async(t,e)=>{e.url&&await s({tabId:t,url:e.url})})),chrome.tabs.onRemoved.addListener((t=>{o({tabId:t})})),chrome.tabs.onReplaced.addListener(((t,e)=>{o({tabId:e})}))})();